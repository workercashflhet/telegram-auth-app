<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel of Fortune</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="app-container">
        <!-- –í–∫–ª–∞–¥–∫–∞ –ì–ª–∞–≤–Ω–∞—è -->
        <div id="homeTab" class="tab-content active">
            <h1 class="page-title">üé∞ –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´</h1>
            
            <!-- –°—Ç–∞—Ç—É—Å -->
            <div id="statusMessage" class="status-message">
                <span id="statusText"></span>
            </div>

            <div class="game-info">
                <div style="color: #666; font-size: 0.9rem; text-align: center; margin: 15px 0;">
                    <p>üéÆ <strong>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</strong></p>
                    <p>1. –ù–∞–∂–º–∏—Ç–µ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"</p>
                    <p>2. –ñ–¥–∏—Ç–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤</p>
                    <p>3. –ö–æ–≥–¥–∞ –±—É–¥–µ—Ç 2+ —É—á–∞—Å—Ç–Ω–∏–∫–∞, –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è 30-—Å–µ–∫—É–Ω–¥–Ω—ã–π —Ç–∞–π–º–µ—Ä</p>
                    <p>4. –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞ –∫–æ–ª–µ—Å–æ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ -->
            <div id="authIndicator" style="display: none; text-align: center; margin: 10px 0; padding: 10px; background: rgba(0,255,0,0.1); border-radius: 10px;">
                <span style="color: #4ecdc4;">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫: <span id="currentUserName">–ò–º—è</span></span>
            </div>
            
            <!-- –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã -->
            <div class="game-timer-container">
                <div id="gameTimer" class="game-timer">0</div>
                <div id="timerLabel" class="timer-label">–£–ß–ê–°–¢–ù–ò–ö–û–í</div>
            </div>
            
            <!-- –ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã -->
            <div class="wheel-container">
                <div class="wheel-wrapper">
                    <div id="fortuneWheel" class="wheel">
                        <div id="wheelParticipants"></div>
                    </div>
                    <div class="wheel-center"></div>
                    <div class="wheel-pointer">‚ñº</div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
               <!-- index.html - –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
                <div class="game-controls">
                    <!-- –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ" -->
                    <button id="joinButton" class="game-button">
                        <span class="icon">‚ûï</span>
                        –£–ß–ê–°–¢–í–û–í–ê–¢–¨
                    </button>
                    <!-- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—è—Å–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç -->
                    <div style="color: #666; font-size: 0.9rem; text-align: center; margin-top: 10px;">
                        –ò–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è 2-—Ö –∏–≥—Ä–æ–∫–æ–≤
                    </div>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="participants-list">
                <h3 class="participants-title">
                    <span class="icon">üë•</span>
                    –£–ß–ê–°–¢–ù–ò–ö–ò
                </h3>
                <div id="participantsList"></div>
            </div>
            
            <!-- –ü–æ–±–µ–¥–∏—Ç–µ–ª—å -->
            <div id="winnerSection" class="winner-section">
                <h3 class="winner-title">üéâ –ü–û–ë–ï–î–ò–¢–ï–õ–¨!</h3>
                <div id="winnerAvatar" class="winner-avatar">
                    <div class="initials">W</div>
                </div>
                <div id="winnerName" class="winner-name">–ò–º—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</div>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –ü—Ä–æ—Ñ–∏–ª—å -->
        <div id="profileTab" class="tab-content">
            <h1 class="page-title">üë§ –ü–†–û–§–ò–õ–¨</h1>
            
            <div class="profile-tab">
                <!-- –ë–µ–π–¥–∂ —Ä–µ–∞–ª—å–Ω—ã—Ö/–¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö -->
                <div id="dataBadge" class="status-badge badge-demo">
                    <span id="badgeText">–î–ï–ú–û –†–ï–ñ–ò–ú</span>
                </div>
                
                <!-- –ê–≤–∞—Ç–∞—Ä –∏ –∏–º—è -->
                <div class="profile-header">
                    <div id="profileAvatar" class="profile-avatar">
                        <div id="profileInitials" class="initials">T</div>
                        <img id="profilePhoto" style="display: none;">
                    </div>
                    <h2 id="userName" class="profile-name">Telegram User</h2>
                    <div id="userUsername" class="profile-username">@username</div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div id="profileInfo" class="profile-info-grid">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                <div style="text-align: center; margin-top: 30px;">
                    <button id="logoutButton" class="game-button" style="background: #ff6b6b;">
                        <span class="icon">üö™</span>
                        –í–´–ô–¢–ò
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="app-nav">
        <button id="navHome" class="nav-button active" data-tab="homeTab">
            <span class="icon">üé∞</span>
            –ì–ª–∞–≤–Ω–∞—è
        </button>
        <button id="navProfile" class="nav-button" data-tab="profileTab">
            <span class="icon">üë§</span>
            –ü—Ä–æ—Ñ–∏–ª—å
        </button>
    </nav>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="/wheel.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let tg = null;
        let currentUser = null;
        let isTelegramApp = false;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        const dataBadge = document.getElementById('dataBadge');
        const badgeText = document.getElementById('badgeText');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
        function initTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.expand();
                tg.ready();
                tg.setHeaderColor('#000000');
                tg.setBackgroundColor('#000000');
                isTelegramApp = true;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                if (tg.initData) {
                    autoLogin();
                    updateAuthIndicator();
                }
                
                return true;
            }
            return false;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthIndicator() {
            const authIndicator = document.getElementById('authIndicator');
            const currentUserName = document.getElementById('currentUserName');
            
            if (window.currentUser) {
                authIndicator.style.display = 'block';
                currentUserName.textContent = window.currentUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            } else {
                authIndicator.style.display = 'none';
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
        async function autoLogin() {
            try {
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                
                const data = await response.json();
                
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ autoLogin –∏–ª–∏ login:
                if (data.success && data.user) {
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                    window.currentUser = data.user;
                    
                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä—ã –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                    if (window.fortuneWheel) {
                        window.fortuneWheel.updateButtons();
                        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –∏–≥—Ä–µ
                        window.fortuneWheel.loadGameState();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    showStatus(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.user.first_name}!`, 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ—Ñ–∏–ª—è
                    updateProfileTab();
                    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    window.syncAppState = function() {
                        console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è...');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∏–≥—Ä—ã
                        if (window.fortuneWheel) {
                            window.fortuneWheel.updateButtons();
                            window.fortuneWheel.loadGameState();
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                        if (window.currentUser) {
                            updateProfileTab();
                        }
                        
                        return '–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                    };
                }
            } catch (error) {
                console.error('Auto login error:', error);
            }
        }
        
        function addRealParticipant(user) {
            if (!window.fortuneWheel || !user) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ
            const isAlreadyParticipating = window.fortuneWheel.participants.some(p => p.id === user.id);
            if (isAlreadyParticipating) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏–≥—Ä—É
            window.fortuneWheel.addParticipant(user);
        }

        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, type = 'info') {
            statusText.textContent = message;
            statusMessage.className = `status-message status-${type} visible`;
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ
            if (type !== 'error') {
                setTimeout(() => {
                    statusMessage.classList.remove('visible');
                }, 3000);
            }
            
            window.showStatus = showStatus; // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ—Ñ–∏–ª—è
        function updateProfileTab() {
            if (!currentUser) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
            const profileAvatar = document.getElementById('profileAvatar');
            const profileInitials = document.getElementById('profileInitials');
            const profilePhoto = document.getElementById('profilePhoto');
            const userName = document.getElementById('userName');
            const userUsername = document.getElementById('userUsername');
            const profileInfo = document.getElementById('profileInfo');
            
            if (currentUser.photo_url) {
                profilePhoto.src = currentUser.photo_url;
                profilePhoto.style.display = 'block';
                profileInitials.style.display = 'none';
            } else {
                const initials = getInitials(currentUser.first_name, currentUser.last_name);
                profileInitials.textContent = initials;
                profileInitials.style.display = 'block';
                profilePhoto.style.display = 'none';
            }
            
            userName.textContent = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim();
            userUsername.textContent = currentUser.username ? `@${currentUser.username}` : '–ë–µ–∑ username';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            profileInfo.innerHTML = '';
            
            const infoCards = [
                { label: 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', value: currentUser.id, icon: 'üÜî' },
                { label: '–ò–º—è', value: currentUser.first_name || '‚Äî', icon: 'üë§' },
                { label: '–§–∞–º–∏–ª–∏—è', value: currentUser.last_name || '‚Äî', icon: 'üë•' },
                { label: 'Username', value: currentUser.username ? '@' + currentUser.username : '‚Äî', icon: 'üìõ' },
                { label: '–Ø–∑—ã–∫', value: currentUser.language_code?.toUpperCase() || 'RU', icon: 'üåê' },
                { label: 'Premium —Å—Ç–∞—Ç—É—Å', value: currentUser.is_premium ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ –∞–∫—Ç–∏–≤–µ–Ω', icon: '‚≠ê' },
                { label: '–î–æ—Å—Ç—É–ø –∫ –õ–°', value: currentUser.allows_write_to_pm ? '‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω' : '‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω', icon: 'üí¨' },
                { label: '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', value: new Date().toLocaleDateString('ru-RU'), icon: 'üìÖ' },
                { label: '–£—á–∞—Å—Ç–∏–µ –≤ –∏–≥—Ä–∞—Ö', value: '0 –ø–æ–±–µ–¥', icon: 'üèÜ' },
                { label: '–°—Ç–∞—Ç—É—Å', value: '–û–Ω–ª–∞–π–Ω', icon: 'üíö' }
            ];
            
            infoCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'info-card';
                cardElement.innerHTML = `
                    <div class="info-label">
                        <span class="icon">${card.icon}</span>
                        ${card.label}
                    </div>
                    <div class="info-value">${card.value}</div>
                `;
                profileInfo.appendChild(cardElement);
            });
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª—ã
        function getInitials(firstName, lastName) {
            const first = firstName ? firstName.charAt(0).toUpperCase() : 'T';
            const last = lastName ? lastName.charAt(0).toUpperCase() : '';
            return first + last;
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(tab => tab.classList.remove('active'));
                    
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        function addDemoParticipants() {
            // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ API
            console.log('–î–µ–º–æ-—Ä–µ–∂–∏–º: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ');
        }
        
        // –í—ã–π—Ç–∏
        function logout() {
            currentUser = null;
            dataBadge.className = 'status-badge badge-demo';
            badgeText.textContent = '–î–ï–ú–û –†–ï–ñ–ò–ú';
            updateProfileTab();
            showStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'success');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById('navHome').click();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            initTelegram();
            setupNavigation();
            
            if (!isTelegramApp) {
                showStatus('‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
                setTimeout(addDemoParticipants, 2000);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
            document.getElementById('logoutButton')?.addEventListener('click', logout);
            
            // –î–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
            window.currentUser = currentUser;
            window.showStatus = showStatus;
        });
    </script>
</body>
</html>